name: Bluecherry Client Flutter
on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  build_android:
    name: Bluecherry Client Android
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive
      - uses: subosito/flutter-action@v1
        with:
          channel: "master"
      # TODO: Signing Android application.
      # - name: Create Key Store
      #   id: create_key_store
      #   uses: timheuer/base64-to-file@v1
      #   with:
      #     fileName: "keystore.pfx"
      #     encodedString: ${{ secrets.KEY_STORE }}
      # - name: Create Key Properties
      #   id: create_key_properties
      #   uses: timheuer/base64-to-file@v1
      #   with:
      #     fileName: "key.properties"
      #     encodedString: ${{ secrets.KEY_PROPERTIES }}
      # - run: cp "${{ steps.create_key_store.outputs.filePath }}" android/app/keystore.jks
      # - run: cp "${{ steps.create_key_properties.outputs.filePath }}" android/key.properties
      - run: dart pub global activate intl_utils 2.1.0
      - run: flutter gen-l10n
      - run: flutter pub upgrade
      - run: flutter pub get
      - run: flutter build apk --verbose --split-per-abi
      - run: cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk bluecherry-android-arm64-v8a-release.apk
      - run: cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk bluecherry-android-armeabi-v7a-release.apk
      - run: cp build/app/outputs/flutter-apk/app-x86_64-release.apk bluecherry-android-x86_64-release.apk
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          prerelease: false
          body: ""
          tag_name: "vnext"
          files: |
            bluecherry-android-arm64-v8a-release.apk
            bluecherry-android-armeabi-v7a-release.apk
            bluecherry-android-x86_64-release.apk
          token: ${{ secrets.GITHUB_TOKEN }}

  build_windows:
    name: Bluecherry Client Windows
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: Checkout fred
        uses: actions/checkout@v2
        with:
          repository: 'freenet/fred'
          fetch-depth: 0
          path: 'fred'

      - name: Download fred from the Github Release
        uses: i3h/download-release-asset@v1.1.0
        with:
          owner: "freenet"
          repo: "fred"
          tag: "latest"
          file: "freenet.jar"

      - uses: subosito/flutter-action@v1
        with:
          channel: "master"
      - run: dart pub global activate intl_utils 2.1.0
      - run: flutter gen-l10n
      - run: flutter pub upgrade
      - run: flutter pub get
      - run: flutter build windows --verbose

      - name: Building the installer
        run: |
          "%programfiles(x86)%\Inno Setup 6\iscc.exe" "installer/windows-installer.iss"
        shell: cmd

      - run: cp installer\Output\bluecherry-dvr-setup.exe bluecherry-dvr-setup.exe

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          prerelease: false
          body: ""
          tag_name: "vnext"
          files: |
            bluecherry-dvr-setup.exe
          token: ${{ secrets.GITHUB_TOKEN }}
